<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>U.M.D</title>

<style>
    body {
        margin: 0;
        background: black;
        overflow: hidden;
    }

    #game-container {
        width: 100vw;
        height: 100vh;
        background: black;
    }

    .back {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0,0,0,0.5);
        padding: 10px 16px;
        border-radius: 8px;
        color: white;
        text-decoration: none;
        border: 2px solid #666;
        z-index: 9999;
        font-size: 18px;
    }

    .back:hover {
        background: rgba(40,40,40,0.6);
    }
</style>
</head>
<body>

<a class="back" href="index.html" target="_blank">✖ Stäng</a>

<div id="game-container">
 <!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Monster Defense</title>
    <!-- Importerar Tailwind CSS för snabb styling av UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sätter en mörk bakgrundsfärg för hela sidan */
        body {
            background-color: #1a202c; /* mörkgrå */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 10vh;
            overflow: hidden; /* Förhindrar scrollning */
            font-family: 'Inter', sans-serif;
            padding: 20px;
        }
        /* Stilar för själva spel-canvasen */
        canvas {
            background-color: #2d3748; /* lite ljusare grå */
            display: block;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4, 6, 0.05);
            cursor: default; /* Standardpekare */
        }
        /* Styling för alla centrala menyer/modals */
        .menu-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1f2937; /* Lätt mörkare bakgrund */
            border: 2px solid #60a5fa; /* Blå kant */
            border-radius: 12px;
            padding: 3rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            z-index: 20;
            width: 90%;
            max-width: 500px;
            color: white; /* Säkerställ att texten är vit i modals */
        }
        /* Knappstyling för menyn */
        .menu-button {
            width: 100%;
            margin-bottom: 1rem;
            padding: 0.75rem 1.5rem;
            font-size: 1.125rem;
            font-weight: bold;
            color: white;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            background-color: #3b82f6; /* Blå */
        }
        .menu-button:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .menu-button:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.5);
        }

    </style>
</head>
<body class="text-white">

    <!-- Start Meny -->
    <div id="startMenu" class="menu-modal">
        <h1 class="text-6xl font-extrabold text-center mb-10 text-yellow-400 tracking-wider">
            Ultimate Monster Defense
        </h1>
        <button id="startGameButton" class="menu-button bg-green-500 hover:bg-green-600">
            START GAME
        </button>
        <button id="sandboxButton" class="menu-button bg-indigo-500 hover:bg-indigo-600">
            SANDBOX
        </button>
        <button id="controlsButton" class="menu-button bg-gray-500 hover:bg-gray-600">
            CONTROLS (KEYBINDS)
        </button>
        <button id="creditsButton" class="menu-button bg-gray-500 hover:bg-gray-600">
            CREDITS
        </button>
    </div>

    <!-- Controls Modal -->
    <div id="controlsModal" class="menu-modal hidden">
        <h2 class="text-3xl font-bold mb-4 text-center border-b border-gray-600 pb-2 text-blue-400">Controls (Keybinds)</h2>
        <div class="space-y-3 text-lg">
            <p><span class="font-bold text-yellow-300">E:</span> Öppna/Stäng Sälj/Upgrade Meny (Spelet Fortsätter)</p>
            <p><span class="font-bold text-yellow-300">F:</span> Öppna/Stäng Bygg Meny (Spelet Fortsätter)</p>
            <p><span class="font-bold text-yellow-300">L:</span> Pausa Spelet / Öppna Pausmeny</p>
            <p><span class="font-bold text-yellow-300">Musklick:</span> Placera Byggnad</p>
        </div>
        <button id="closeControlsButton" class="menu-button bg-red-500 hover:bg-red-600 mt-6">
            Tillbaka till Huvudmeny
        </button>
    </div>

    <!-- Credits Modal -->
    <div id="creditsModal" class="menu-modal hidden">
        <h2 class="text-3xl font-bold mb-4 text-center border-b border-gray-600 pb-2 text-blue-400">Credits</h2>
        <p class="text-4xl text-center font-extrabold text-yellow-300 py-4">Zayn Lilak</p>
        <p class="text-center text-gray-400">Spelets design och idé.</p>
        <button id="closeCreditsButton" class="menu-button bg-red-500 hover:bg-red-600 mt-6">
            Tillbaka till Huvudmeny
        </button>
    </div>

    <!-- Paus Meny -->
    <div id="pauseMenu" class="menu-modal hidden">
        <h2 class="text-5xl font-extrabold mb-8 text-center text-yellow-400">SPELET PAUSAT</h2>
        <button id="resumeButton" class="menu-button bg-green-500 hover:bg-green-600">
            ÅTERUPPTA SPEL
        </button>
        <button id="restartButton" class="menu-button bg-blue-500 hover:bg-blue-600">
            STARTA OM
        </button>
        <button id="returnToMenuButton" class="menu-button bg-red-500 hover:bg-red-600">
            ÅTERGÅ TILL HUVUDMENY
        </button>
    </div>

    <!-- Spel-kontainer som håller både canvas och UI-element -->
    <!-- Döljer hela spel-kontainern tills spelet startas -->
    <div id="gameContainer" class="relative hidden">
        <!-- Spelytan där allt ritas -->
        <canvas id="gameCanvas"></canvas>

        <!-- UI-överlägg för statistik (Coins, Waste och nya resurser) -->
        <div id="statsContainer" class="absolute top-4 right-4 bg-gray-900 bg-opacity-80 p-4 rounded-lg shadow-xl w-48">
            <h3 class="text-lg font-bold border-b border-gray-600 pb-2 mb-2">Resurser</h3>
            <div id="coinsDisplay" class="text-yellow-400 text-lg">Coins: 0</div>
            <div id="wasteDisplay" class="text-green-400 text-lg">Waste: 0</div>
            <!-- NYA RESURSER -->
            <div id="foodDisplay" class="text-red-400 text-lg">Food: 0</div>
            <div id="woodDisplay" class="text-orange-400 text-lg">Wood: 0</div>
            <div id="metalDisplay" class="text-gray-400 text-lg">Metal: 0</div>
            <div id="earthDisplay" class="text-yellow-600 text-lg">Earth: 0</div>
            <div id="modeDisplay" class="mt-2 text-sm font-bold text-indigo-400">Mode: Standard</div>
        </div>

        <!-- Tornets nivå-display (längst nere till vänster, endast Lvl X) -->
        <div id="towerLevelHUD" class="absolute bottom-8 left-12 bg-gray-900 bg-opacity-80 p-3 rounded-xl shadow-2xl border-2 border-yellow-500">
            <p id="towerLevelDisplay" class="text-4xl font-extrabold text-yellow-400">Lvl 1</p>
        </div>


        <!-- Sälj- och Uppgraderingsmeny (aktiveras med 'E') -->
        <div id="sellMenu" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900 bg-opacity-95 p-6 rounded-lg shadow-xl w-80 hidden border-2 border-blue-500 z-10">
            <h2 class="text-2xl font-bold mb-4 text-center border-b border-gray-700 pb-2">Kontrollpanel</h2>

            <!-- Sälj Sektion -->
            <div class="mb-6 pb-4 border-b border-gray-700">
                <h3 class="text-xl font-semibold mb-2 text-green-400">Sälj Monster Waste</h3>
                <p class="mb-3 text-gray-300">Du har <span id="wasteToSell" class="font-bold text-green-400">0</span> Monster Waste.</p>
                <p class="mb-4 text-gray-400 text-sm">Värde: 2 Coins per Waste</p>
                
                <button id="sellButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    SÄLJ ALLT
                </button>
            </div>

            <!-- Uppgraderings Sektion -->
            <div>
                <h3 class="text-xl font-semibold mb-2 text-blue-400">Huvudtorn Uppgradering</h3>
                <p class="text-lg mb-1">Nuvarande nivå: <span id="currentLevelInMenu" class="font-bold text-yellow-400">Lvl 1</span></p>
                <p id="upgradeCostDisplay" class="text-base text-gray-400 mb-3">Kostnad: 20 C</p>
                <button id="upgradeButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    UPPGRADERA TORNET
                </button>
            </div>
            
            <p class="text-xs text-gray-500 mt-4 text-center">Tryck 'E' för att stänga. Tryck 'L' för paus.</p>
        </div>
        
        <!-- Byggnadsmeny (aktiveras med 'F') -->
        <div id="buildMenu" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900 bg-opacity-95 p-6 rounded-lg shadow-xl w-80 hidden border-2 border-green-500 z-10">
            <h2 class="text-2xl font-bold mb-4 text-center border-b border-gray-700 pb-2">Byggmeny</h2>

            <!-- Farm Sektion -->
            <div class="mb-4 pb-4 border-b border-gray-700">
                <h3 class="text-xl font-semibold mb-2 text-lime-400">Farm</h3>
                <p id="farmCostDisplay" class="text-base text-gray-400 mb-2">Kostnad: 20 Coins</p>
                <p class="text-sm text-gray-500 mb-3">Genererar: Food och Wood</p>
                <button id="selectFarmButton" data-building="FARM" class="w-full bg-lime-600 hover:bg-lime-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    VÄLJ FARM
                </button>
            </div>

            <!-- Gruva Sektion -->
            <div>
                <h3 class="text-xl font-semibold mb-2 text-yellow-600">Gruva</h3>
                <p id="mineCostDisplay" class="text-base text-gray-400 mb-2">Kostnad: 15 Wood</p>
                <p class="text-sm text-gray-500 mb-3">Genererar: Metal, Coins och Earth</p>
                <button id="selectMineButton" data-building="MINE" class="w-full bg-yellow-700 hover:bg-yellow-800 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-105">
                    VÄLJ GRUVA
                </button>
            </div>
            
            <p class="text-xs text-gray-500 mt-4 text-center">Tryck 'F' för att stänga. Klicka på duken för att placera.</p>
        </div>
    </div>

    <script>
        // --- DOM-element ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer');
        
        // Meny-element
        const startMenu = document.getElementById('startMenu');
        const startGameButton = document.getElementById('startGameButton');
        const sandboxButton = document.getElementById('sandboxButton');
        const controlsButton = document.getElementById('controlsButton');
        const creditsButton = document.getElementById('creditsButton');
        const controlsModal = document.getElementById('controlsModal');
        const creditsModal = document.getElementById('creditsModal');
        const closeControlsButton = document.getElementById('closeControlsButton');
        const closeCreditsButton = document.getElementById('closeCreditsButton');
        const pauseMenu = document.getElementById('pauseMenu'); 
        const resumeButton = document.getElementById('resumeButton'); 
        const restartButton = document.getElementById('restartButton'); 
        const returnToMenuButton = document.getElementById('returnToMenuButton'); 
        
        // UI-paneler och displayer
        const coinsDisplay = document.getElementById('coinsDisplay');
        const wasteDisplay = document.getElementById('wasteDisplay');
        const foodDisplay = document.getElementById('foodDisplay');
        const woodDisplay = document.getElementById('woodDisplay');
        const metalDisplay = document.getElementById('metalDisplay');
        const earthDisplay = document.getElementById('earthDisplay');
        const modeDisplay = document.getElementById('modeDisplay');
        const sellMenu = document.getElementById('sellMenu');
        const buildMenu = document.getElementById('buildMenu'); 
        const wasteToSell = document.getElementById('wasteToSell');
        const sellButton = document.getElementById('sellButton');
        const upgradeButton = document.getElementById('upgradeButton'); 
        const selectFarmButton = document.getElementById('selectFarmButton'); 
        const selectMineButton = document.getElementById('selectMineButton'); 
        
        // Torn UI element
        const towerLevelDisplay = document.getElementById('towerLevelDisplay'); 
        const currentLevelInMenu = document.getElementById('currentLevelInMenu'); 
        const upgradeCostDisplay = document.getElementById('upgradeCostDisplay'); 

        // Sätter storleken på canvas
        canvas.width = 1000;
        canvas.height = 600;

        // --- Spelvariabler ---
        let gameState = 'MENU'; // Spel-tillstånd: 'MENU', 'PLAYING', 'PAUSED', 'GAME_OVER'
        let coins = 0;
        let monsterWaste = 0;
        let food = 0; 
        let wood = 0; 
        let metal = 0; 
        let earth = 0; 
        
        const WASTE_COIN_VALUE = 2; 
        let gameRunning = false; 
        let menuOpen = false; // Säljmeny/Uppgraderingsmeny öppen
        let isBuildingMode = false; // Byggmeny öppen
        let selectedBuildingType = null; // Typ av byggnad som ska placeras
        let baseHealth = 100; 
        let isSandboxMode = false; 

        // Spel-arrayer
        let monsters = [];
        let projectiles = [];
        let buildings = []; 
        
        // Uppgraderingskonstanter
        const BASE_UPGRADE_COST = 20; 
        const UPGRADE_COST_MULTIPLIER = 1.25; 
        const DUAL_TURRET_LEVEL = 10; 
        
        // Monster Skalningskonstanter
        const BASE_MONSTER_HP = 70;
        const HP_SCALE_PER_LEVEL = 1.15; // Ökad skalning
        const SPAWN_INTERVAL_SCALE_PER_LEVEL = 0.95; 
        
        // Torn-statistik (Gemensamma konstanter)
        const BASE_TOWER_DAMAGE = 10; 
        const DAMAGE_SCALE_PER_LEVEL = 10; 
        const FIRE_RATE_DECREASE_MULTIPLIER = 0.95; 

        // Initial boost konstanter
        const INITIAL_DAMAGE_BOOST = 20; 
        const INITIAL_FIRE_RATE_BOOST_MS = -200; // Från 1000ms till 800ms
        const BOOST_MAX_LEVEL = 5;

        // Byggnads-konstanter
        const BUILDING_SIZE = 50; 
        const FARM_COST_COINS = 20;
        const MINE_COST_WOOD = 15;
        const BUILD_ZONE_LIMIT = 150; 
        const PRODUCTION_INTERVAL = 5000; 
        const FARM_PRODUCTION = { food: 1, wood: 1 };
        const MINE_PRODUCTION = { metal: 1, coins: 5, earth: 1 };
        
        // --- Monster-spawning ---
        let baseSpawnInterval = 7000; 
        let lastSpawn = 0;
        
        // --- Torn-instanser ---
        let tower = null; // Huvudtornet
        let tower2 = null; // Sekundärt torn (null tills nivå 10)

        // --- Game Logic Functions ---

        /**
         * Visar huvudmenyn och döljer spelet.
         */
        function showMenu() {
            gameState = 'MENU';
            gameRunning = false;
            gameContainer.classList.add('hidden');
            startMenu.classList.remove('hidden');
            pauseMenu.classList.add('hidden'); 
            sellMenu.classList.add('hidden');
            buildMenu.classList.add('hidden');
        }
        
        /**
         * Startar spelet och döljer menyn.
         * @param {string} mode - 'standard' eller 'sandbox'
         */
        function startGame(mode) {
            gameState = 'PLAYING';
            gameRunning = true;
            startMenu.classList.add('hidden');
            pauseMenu.classList.add('hidden'); 
            gameContainer.classList.remove('hidden');

            isSandboxMode = (mode === 'sandbox'); 
            modeDisplay.textContent = `Mode: ${isSandboxMode ? 'Sandbox (Oändligt)' : 'Standard'}`;

            // Återställ alla tillstånd
            monsters = [];
            projectiles = [];
            buildings = [];
            baseHealth = 100; 
            baseSpawnInterval = 7000;
            
            // Återställ resurser
            coins = 0; 
            monsterWaste = 0;
            food = 0; 
            wood = 0; 
            metal = 0; 
            earth = 0; 

            // Skapa torn-instanserna
            tower = new Tower(50, canvas.height / 2);
            tower2 = null; 

            // Ge resurser om Sandbox
            if (isSandboxMode) {
                coins = 5000;
                wood = 5000;
                food = 5000;
                metal = 5000;
                earth = 5000;
            }

            updateUI();
        }

        /**
         * Beräknar uppgraderingskostnaden baserat på tornets nuvarande nivå.
         */
        function getUpgradeCost(currentLevel) {
            let cost = BASE_UPGRADE_COST;
            for (let i = 1; i < currentLevel; i++) {
                cost *= UPGRADE_COST_MULTIPLIER;
            }
            return Math.ceil(cost); 
        }

        /**
         * Växlar paus-läget ('L') och visar pausmenyn.
         * Denna funktion är den ENDA som sätter gameRunning = false (för paus)
         */
        function togglePause() {
            if (gameState === 'PLAYING') {
                gameState = 'PAUSED';
                gameRunning = false;
                // Stäng alla andra menyer
                if (menuOpen) toggleSellMenu(false); // Används för att stänga menyn UTAN att pausa/återuppta
                if (isBuildingMode) toggleBuildMenu(false); 
                pauseMenu.classList.remove('hidden');
            } else if (gameState === 'PAUSED') {
                gameState = 'PLAYING';
                gameRunning = true;
                pauseMenu.classList.add('hidden');
            }
        }
        
        /**
         * Växlar sälj-menyn (öppna/stäng). PAUSAR INTE SPELET.
         * @param {boolean} toggleDisplay - Om UI-displayen ska växlas (standard true).
         */
        function toggleSellMenu(toggleDisplay = true) {
            if (gameState !== 'PLAYING' && gameState !== 'PAUSED') return;

            // Stäng bygg-relaterade lägen om säljmenyn öppnas
            if (isBuildingMode) {
                isBuildingMode = false;
                buildMenu.classList.add('hidden');
                selectedBuildingType = null;
            }
            
            if (toggleDisplay) {
                menuOpen = !menuOpen;
                sellMenu.classList.toggle('hidden');
            } else {
                menuOpen = false;
                sellMenu.classList.add('hidden');
            }
            
            // Spelet fortsätter köra även om menyn är öppen, om inte L är nedtryckt.
            if (gameState === 'PLAYING') {
                 gameRunning = true; 
            }

            updateUI(); 
        }

        /**
         * Växlar bygg-menyn (öppna/stäng). SPELET FORTSÄTTER.
         * @param {boolean} toggleDisplay - Om UI-displayen ska växlas (standard true).
         */
        function toggleBuildMenu(toggleDisplay = true) {
            if (gameState !== 'PLAYING' && gameState !== 'PAUSED') return;

            // Stäng säljmenyn om byggmenyn öppnas
            if (menuOpen) {
                menuOpen = false;
                sellMenu.classList.add('hidden');
            }
            
            if (toggleDisplay) {
                isBuildingMode = !isBuildingMode;
                buildMenu.classList.toggle('hidden');
            } else {
                isBuildingMode = false;
                buildMenu.classList.add('hidden');
            }

            // Återställ vald byggnad när menyn stängs
            if (!isBuildingMode) selectedBuildingType = null; 
            
            // Spelet fortsätter köra även om byggmenyn är öppen.
            if (gameState === 'PLAYING') {
                gameRunning = true; 
            }
            
            updateUI(); 
        }

        /**
         * Kontrollerar om en given position (x, y) överlappar med en befintlig byggnad.
         */
        function checkBuildingCollision(x, y) {
            // Använder en standardstorlek för kollisionsdetektering, oavsett visuell form.
            const size = BUILDING_SIZE; 

            for (const b of buildings) {
                // Kontrollera överlappning mellan rektanglar
                if (x < b.x + b.width / 2 &&
                    x + size / 2 > b.x - b.width / 2 && 
                    y < b.y + b.height / 2 &&
                    y + size / 2 > b.y - b.height / 2) {
                    return true;
                }
            }
            return false;
        }

        // --- Spelklasser ---

        /**
         * Klassen för byggnader (Farm och Gruva)
         */
        class Building {
            constructor(x, y, type) {
                this.x = x; 
                this.y = y; 
                this.type = type; 
                this.productionInterval = PRODUCTION_INTERVAL;
                this.lastProduction = performance.now();
                
                // Unika dimensioner baserat på typ
                if (type === 'FARM') {
                    this.width = 60;  // Bredare för Farm
                    this.height = 30; // Lägre
                    this.color = '#84cc16'; // Lime/grön
                    this.label = 'FARM';
                } else if (type === 'MINE') {
                    this.width = 40;  // Smalare för Gruva
                    this.height = 50; // Högre
                    this.color = '#b8860b'; // Guld/brun
                    this.label = 'GRUVA';
                }
            }

            draw() {
                ctx.fillStyle = this.color;
                
                // Rita olika former baserat på typ
                if (this.type === 'FARM') {
                    // Rektangel (Fält)
                    ctx.fillRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);
                    
                    // Lägg till några ränder för att symbolisera rader
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                    for(let i = 0; i < 3; i++) {
                        ctx.fillRect(this.x - this.width / 2, this.y - this.height / 2 + 5 + i * 10, this.width, 4);
                    }
                    
                } else if (this.type === 'MINE') {
                    // Gruva: Bas + Topp (Triangel)
                    
                    // 1. Gruvbas (rektangel)
                    const baseHeight = this.height * 0.7;
                    ctx.fillRect(this.x - this.width / 2, this.y + this.height / 2 - baseHeight, this.width, baseHeight);
                    
                    // 2. Gruvtopp (triangel/tak)
                    ctx.beginPath();
                    ctx.moveTo(this.x - this.width / 2 - 5, this.y + this.height / 2 - baseHeight); // Vänster bas
                    ctx.lineTo(this.x + this.width / 2 + 5, this.y + this.height / 2 - baseHeight); // Höger bas
                    ctx.lineTo(this.x, this.y - this.height / 2); // Toppunkt
                    ctx.closePath();
                    ctx.fillStyle = '#6e7783'; // Mörkare grå för taket
                    ctx.fill();
                    
                    // Fönster/ingång på basen
                    ctx.fillStyle = '#1e293b'; 
                    ctx.fillRect(this.x - 10, this.y + this.height / 2 - baseHeight + 5, 20, baseHeight - 10);
                }

                // Etikett
                ctx.fillStyle = 'white';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(this.label, this.x, this.y + this.height / 2 + 15);
                
                // Produktionsstapel (ritas oavsett form)
                const progress = (performance.now() - this.lastProduction) / this.productionInterval;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                // Placeras ovanför byggnaden
                ctx.fillRect(this.x - 20, this.y - this.height / 2 - 10, 40 * Math.min(progress, 1), 5);
            }

            update(currentTime) {
                if (currentTime - this.lastProduction > this.productionInterval) {
                    this.lastProduction = currentTime;
                    
                    if (this.type === 'FARM') {
                        food += FARM_PRODUCTION.food;
                        wood += FARM_PRODUCTION.wood;
                        
                    } else if (this.type === 'MINE') {
                        metal += MINE_PRODUCTION.metal;
                        coins += MINE_PRODUCTION.coins;
                        earth += MINE_PRODUCTION.earth;
                    }
                    updateUI(); 
                }
            }
        }
        
        /**
         * Klassen för spelarens torn
         */
        class Tower {
            constructor(startX, startY) {
                this.width = 60;
                this.height = 100;
                this.x = startX;
                this.y = startY - (this.height / 2); 
                this.level = 1; 
                this.baseRange = 550; 
                
                this.baseFireRate = 1000; 
                this.baseDamage = BASE_TOWER_DAMAGE; 

                // Beräknade stats
                this.range = 0; 
                this.fireRate = 0;
                this.projectileDamage = 0;
                
                this.lastShot = 0; 
                
                // Rotationsvariabler
                this.angle = 0; 
                this.rotationSpeed = 0.05; 
                this.pivotX = this.x + this.width / 4; 
                this.pivotY = this.y + this.height / 2; 

                // Recoil-effekt
                this.recoilOffset = 0;
                this.maxRecoil = 5;
                this.recoilDecay = 0.9;
                
                this.upgrade(false); 
            }
            
            /**
             * Beräknar tornets stats med hänsyn till nivå och eventuell start-boost.
             */
            calculateStats() {
                // Beräkna grundläggande nivå-stats
                let calculatedDamage = this.baseDamage + (this.level - 1) * DAMAGE_SCALE_PER_LEVEL;
                let calculatedFireRate = this.baseFireRate * Math.pow(FIRE_RATE_DECREASE_MULTIPLIER, this.level - 1);
                
                // Lägg till start-boost om nivån är lägre än eller lika med max boost-nivå
                if (this.level < BOOST_MAX_LEVEL) {
                    calculatedDamage += INITIAL_DAMAGE_BOOST;
                    calculatedFireRate += INITIAL_FIRE_RATE_BOOST_MS; 
                    // Se till att Fire Rate inte blir negativ
                    calculatedFireRate = Math.max(100, calculatedFireRate);
                }

                // Tilldela de beräknade värdena
                this.range = this.baseRange * (1 + (this.level * 0.1)); 
                this.fireRate = calculatedFireRate;
                this.projectileDamage = calculatedDamage;
            }

            /**
             * Uppgraderar tornets statistik baserat på nivån.
             */
            upgrade(isRealUpgrade = true) {
                if (isRealUpgrade) {
                    this.level++;
                }
                this.calculateStats();
            }

            // Ritar ut tornet
            draw() {
                // Basen 
                ctx.fillStyle = '#5a67d8'; 
                ctx.fillRect(this.x, this.y, this.width, this.height);

                // Uppdatera recoil
                this.recoilOffset *= this.recoilDecay;

                // Spara canvas-kontexten
                ctx.save();
                
                // Flytta origo (0,0) till tornets pivot-punkt
                ctx.translate(this.pivotX, this.pivotY);
                
                // Rotera hela canvasen runt den nya origo-punkten
                ctx.rotate(this.angle);

                // --- Machine Gun Design ---
                ctx.fillStyle = '#4a5568'; 
                ctx.fillRect(-20, -15, 40, 30); 
                
                const barrelLength = this.width + 10;
                const barrelWidth = 8;
                ctx.fillStyle = '#a0aec0'; 
                ctx.fillRect(-20 - this.recoilOffset, -barrelWidth / 2, barrelLength + this.recoilOffset, barrelWidth); 

                ctx.fillStyle = '#333333';
                ctx.fillRect(barrelLength - 10 - this.recoilOffset, -barrelWidth / 2, 10, barrelWidth); 

                ctx.fillStyle = 'cyan';
                ctx.beginPath();
                ctx.arc(barrelLength / 2 - this.recoilOffset, 0, 5, 0, Math.PI * 2);
                ctx.fill();

                // Återställ canvas-kontexten
                ctx.restore();
            }

            // Uppdaterar tornet (roterar, hittar mål och skjuter)
            update(currentTime) {
                // Steg 1: Hitta ett mål
                let target = null;
                let closestDist = this.range;

                for (const monster of monsters) {
                    const dist = Math.hypot(monster.x - this.pivotX, monster.y - this.pivotY);
                    if (dist < closestDist) {
                        closestDist = dist;
                        target = monster;
                    }
                }

                let isAimed = false;

                // Steg 2: Rotera mot målet
                if (target) {
                    const targetAngle = Math.atan2(target.y - this.pivotY, target.x - this.pivotX);
                    let diff = targetAngle - this.angle;

                    while (diff < -Math.PI) diff += Math.PI * 2;
                    while (diff > Math.PI) diff -= Math.PI * 2;

                    if (Math.abs(diff) < this.rotationSpeed) {
                        this.angle = targetAngle;
                        isAimed = true;
                    } else {
                        this.angle += Math.sign(diff) * this.rotationSpeed;
                    }
                }

                // Steg 3: Skjut
                if (target && isAimed && currentTime - this.lastShot > this.fireRate) {
                    this.shoot(target);
                    this.lastShot = currentTime;
                    this.recoilOffset = this.maxRecoil;
                }
            }

            // Skapar en ny projektil
            shoot(target) {
                const startX = this.pivotX + Math.cos(this.angle) * (this.width - 10);
                const startY = this.pivotY + Math.sin(this.angle) * (this.width - 10);
                
                projectiles.push(new Projectile(startX, startY, target, this.projectileDamage, this.angle));
            }
        }

        /**
         * Klassen för monster
         */
        class Monster {
            constructor(x, y, maxHp, speed, color) {
                this.maxHp = maxHp;
                this.hp = this.maxHp;
                
                this.radius = 15;
                this.x = x; 
                this.y = y; 
                this.speed = speed; 
                this.color = color; 
            }

            draw() {
                // Kropp
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();

                // Ögon
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(this.x - 5, this.y - 4, 3, 0, Math.PI * 2);
                ctx.arc(this.x + 5, this.y - 4, 3, 0, Math.PI * 2);
                ctx.fill();

                // HP-mätare (bakgrund)
                ctx.fillStyle = 'red';
                ctx.fillRect(this.x - this.radius, this.y - this.radius - 10, this.radius * 2, 5);
                
                // HP-mätare (nuvarande hälsa)
                ctx.fillStyle = 'lime';
                const hpWidth = (this.hp / this.maxHp) * (this.radius * 2);
                ctx.fillRect(this.x - this.radius, this.y - this.radius - 10, hpWidth, 5);
            }

            update() {
                this.x -= this.speed;
            }

            takeDamage(amount) {
                this.hp -= amount;
            }
        }

        /**
         * Klassen för projektiler
         */
        class Projectile {
            constructor(x, y, target, damage, angle) {
                this.x = x;
                this.y = y;
                this.target = target;
                this.damage = damage;
                this.radius = 5;
                this.speed = 5;
                this.color = 'cyan';
                
                // Beräknar initial velocity baserat på tornets vinkel (för fast bana)
                this.vx = Math.cos(angle) * this.speed;
                this.vy = Math.sin(angle) * this.speed;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
            }

            update() {
                // Homing-läge: Om målet fortfarande finns
                if (this.target && this.target.hp > 0) {
                    const dx = this.target.x - this.x;
                    const dy = this.target.y - this.y;
                    const dist = Math.hypot(dx, dy);

                    if (dist > 0) {
                        const dirX = dx / dist;
                        const dirY = dy / dist;
                        
                        this.x += dirX * this.speed;
                        this.y += dirY * this.speed;
                        
                        this.vx = dirX * this.speed;
                        this.vy = dirY * this.speed;
                    } else {
                        // Nådde målets nuvarande position, nollställ target för att gå över till fast bana
                        this.target = null;
                    }
                    
                } else {
                    // Fast bana-läge: Målet är dött/null.
                    this.target = null;
                    this.x += this.vx;
                    this.y += this.vy;
                }
            }
        }

        // --- Huvud-torn logik ---

        /**
         * Uppgraderar båda tornen och hanterar skapandet av tower2 vid nivå 10.
         */
        function upgradeTower() {
            if (!tower) return;
            const cost = getUpgradeCost(tower.level);
            
            if (isSandboxMode || coins >= cost) {
                if (!isSandboxMode) {
                    coins -= cost;
                }
                
                // Steg 1: Uppgradera det primära tornet
                tower.upgrade(true); 
                
                // Steg 2: Synkronisera stats till eventuella sekundära torn
                if (tower2) {
                    tower2.level = tower.level;
                    tower2.upgrade(false); 
                }
                
                // Steg 3: Skapa det andra tornet om vi når DUAL_TURRET_LEVEL
                if (tower.level >= DUAL_TURRET_LEVEL && !tower2) {
                    // Justera tower positioner för att centrera de dubbla tornen
                    const offset = 30; // Avstånd från mittlinjen
                    const center = canvas.height / 2;
                    
                    // Skapa det sekundära tornet (placeras nedanför)
                    tower2 = new Tower(50, center + offset);
                    tower2.level = tower.level;
                    tower2.calculateStats(); // Behöver bara kalla calculateStats för att sätta stats
                    
                    // Justera primära tornet (placeras ovanför)
                    tower.y = center - tower.height / 2 - offset;
                    tower.pivotY = tower.y + tower.height / 2;
                }
                
                updateUI();
                console.log(`Torn uppgraderat till nivå ${tower.level}`);
            }
        }
        
        // --- Monster-spawning ---

        function calculateSpawnInterval() {
            let interval = baseSpawnInterval * Math.pow(SPAWN_INTERVAL_SCALE_PER_LEVEL, tower.level - 1);
            return Math.max(interval, 500); 
        }

        function spawnMonster(currentTime) {
            if (!tower) return;
            const spawnInterval = calculateSpawnInterval(); 

            if (currentTime - lastSpawn > spawnInterval) {
                // Beräkna monster HP baserat på tornets nivå (monsterna blir tuffare ju högre nivå tornet har)
                const monsterMaxHp = BASE_MONSTER_HP * Math.pow(HP_SCALE_PER_LEVEL, tower.level - 1);
                const monsterSpeed = Math.random() * 0.7 + 0.3;
                const monsterColor = `hsl(${Math.random() * 60 + 20}, 70%, 50%)`;
                
                const startX = canvas.width + 15;
                const startY = Math.random() * (canvas.height - 30) + 15;
                
                monsters.push(new Monster(startX, startY, monsterMaxHp, monsterSpeed, monsterColor)); 
                lastSpawn = currentTime;
                
                if (baseSpawnInterval > 1500) { 
                    baseSpawnInterval *= 0.99;
                }
            }
        }

        // --- UI-funktioner ---
        
        function updateUI() {
            coinsDisplay.textContent = `Coins: ${coins}`;
            wasteDisplay.textContent = `Waste: ${monsterWaste}`;
            foodDisplay.textContent = `Food: ${food}`;
            woodDisplay.textContent = `Wood: ${wood}`;
            metalDisplay.textContent = `Metal: ${metal}`;
            earthDisplay.textContent = `Earth: ${earth}`;
            
            wasteToSell.textContent = monsterWaste; 
            modeDisplay.textContent = `Mode: ${isSandboxMode ? 'Sandbox (Oändligt)' : 'Standard'}`;

            // Uppdaterar torn-UI
            const levelText = `Lvl ${tower ? tower.level : 1}`;
            towerLevelDisplay.textContent = levelText; 
            if (currentLevelInMenu) {
                currentLevelInMenu.textContent = levelText; 
            }

            const nextCost = getUpgradeCost(tower ? tower.level : 1);
            upgradeCostDisplay.textContent = `Kostnad: ${isSandboxMode ? 'Gratis' : `${nextCost} C`}`;
            
            upgradeButton.disabled = !isSandboxMode && coins < nextCost;
            
            selectFarmButton.disabled = !isSandboxMode && coins < FARM_COST_COINS;
            selectMineButton.disabled = !isSandboxMode && wood < MINE_COST_WOOD;
            
            // Uppdatera muspekare i byggläge
            if (selectedBuildingType && gameState === 'PLAYING') {
                 canvas.style.cursor = 'crosshair';
            } else {
                 canvas.style.cursor = 'default';
            }
        }

        // --- Händelselyssnare (Menyer & Spelkontroller) ---

        // Start Game
        startGameButton.addEventListener('click', () => startGame('standard'));
        
        // Sandbox
        sandboxButton.addEventListener('click', () => startGame('sandbox')); 

        // Pausmeny-knappar
        resumeButton.addEventListener('click', () => togglePause());
        restartButton.addEventListener('click', () => startGame('standard'));
        returnToMenuButton.addEventListener('click', () => showMenu());

        // Controls Modal
        controlsButton.addEventListener('click', () => {
            startMenu.classList.add('hidden');
            controlsModal.classList.remove('hidden');
        });
        closeControlsButton.addEventListener('click', () => {
            controlsModal.classList.add('hidden');
            startMenu.classList.remove('hidden');
        });

        // Credits Modal
        creditsButton.addEventListener('click', () => {
            startMenu.classList.add('hidden');
            creditsModal.classList.remove('hidden');
        });
        closeCreditsButton.addEventListener('click', () => {
            creditsModal.classList.add('hidden');
            startMenu.classList.remove('hidden');
        });

        // Lyssnar efter 'E', 'F' och 'L'
        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (gameState === 'MENU' || gameState === 'GAME_OVER') return;

            if (key === 'e') {
                toggleSellMenu();
            } else if (key === 'f') {
                toggleBuildMenu();
            } else if (key === 'l') {
                // Pausknappen ska alltid fungera när spelet pågår eller är pausat
                togglePause();
            }
        });

        // Lyssnar efter klick på canvas för placering
        canvas.addEventListener('mousedown', (e) => {
            if (gameState !== 'PLAYING' || !selectedBuildingType) return;
                
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // 1. Förhindra byggnation i den blå skyddszonen (x < 150)
            if (x < BUILD_ZONE_LIMIT) {
                console.error("Kan inte bygga i skyddszonen.");
                selectedBuildingType = null;
                updateUI();
                return; 
            }

            // 2. Förhindra byggnadskollision
            if (checkBuildingCollision(x, y)) {
                 console.error("Kan inte placera byggnad ovanpå en annan!");
                 return;
            }

            let costMet = false;

            // 3. Kolla kostnad och drag av resurser
            if (isSandboxMode) {
                costMet = true; 
            } else if (selectedBuildingType === 'FARM' && coins >= FARM_COST_COINS) {
                coins -= FARM_COST_COINS;
                costMet = true;
            } else if (selectedBuildingType === 'MINE' && wood >= MINE_COST_WOOD) {
                wood -= MINE_COST_WOOD;
                costMet = true;
            }

            if (costMet) {
                // 4. Placera byggnad (x, y är centrerad klickposition)
                buildings.push(new Building(x, y, selectedBuildingType));
                
                // Återställ byggläget 
                isBuildingMode = false; 
                selectedBuildingType = null;
                buildMenu.classList.add('hidden');
                
            } else {
                console.error(`Inte tillräckligt med resurser för att bygga ${selectedBuildingType}.`);
                // Återställ byggläget om man klickar men inte har råd
                isBuildingMode = false;
                selectedBuildingType = null;
                buildMenu.classList.add('hidden');
            }
            
            updateUI();
        });

        // Lyssnar efter klick på sälj-knappen
        sellButton.addEventListener('click', () => {
            coins += monsterWaste * WASTE_COIN_VALUE; 
            monsterWaste = 0; 
            updateUI();
        });

        // Lyssnar efter klick på uppgraderingsknappen
        upgradeButton.addEventListener('click', () => {
            if (tower) {
                upgradeTower();
            }
        });

        // Lyssnare för byggknappar
        selectFarmButton.addEventListener('click', () => {
            if (isSandboxMode || coins >= FARM_COST_COINS) {
                selectedBuildingType = 'FARM';
                buildMenu.classList.add('hidden'); 
            } else {
                 console.error("För lite Coins för Farm!");
            }
            updateUI();
        });

        selectMineButton.addEventListener('click', () => {
            if (isSandboxMode || wood >= MINE_COST_WOOD) {
                selectedBuildingType = 'MINE';
                buildMenu.classList.add('hidden'); 
            } else {
                console.error("För lite Wood för Gruva!");
            }
            updateUI();
        });
        
        // --- Bakgrundsritning ---
        function drawBackground() {
            // Mörkgrå bakgrund
            ctx.fillStyle = '#4a5568'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Basens "skyddszon"
            ctx.fillStyle = 'rgba(90, 103, 216, 0.2)';
            ctx.fillRect(0, 0, BUILD_ZONE_LIMIT, canvas.height); 
            
            // Linje för skyddszon
            ctx.strokeStyle = 'rgba(90, 103, 216, 0.5)';
            ctx.lineWidth = 2;
            ctx.strokeRect(BUILD_ZONE_LIMIT, 0, 2, canvas.height); 
            
            // Rita basens hälsa
            if (tower) {
                const healthBarWidth = tower.width * (tower2 ? 2 : 1);
                const healthBarHeight = 15;
                const x = tower.x;
                // Rita hälsofältet under det nedre tornet (om dual) eller huvudtornet
                const y = (tower2 ? tower2.y : tower.y) + tower.height + 10;
                const hpRatio = baseHealth / 100;

                // Grå bakgrund
                ctx.fillStyle = '#ef4444'; // Röd bakgrund
                ctx.fillRect(x, y, healthBarWidth, healthBarHeight);

                // Grön hälsa
                ctx.fillStyle = '#10b981'; // Smaragdgrön
                ctx.fillRect(x, y, healthBarWidth * hpRatio, healthBarHeight);
                
                // Kant
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, healthBarWidth, healthBarHeight);
            }
        }

        // --- Huvud-spellogik ---
        
        let lastFrameTime = 0;

        // Hanterar all uppdatering och ritning
        function gameLoop(currentTime) {
            
            const deltaTime = currentTime - lastFrameTime; 
            lastFrameTime = currentTime;

            // Rensa canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            
            if (gameRunning && gameState === 'PLAYING' && tower) {
                
                // --- Uppdateringslogik ---
                spawnMonster(currentTime);
                
                // Uppdatera torn(en)
                tower.update(currentTime);
                if (tower2) tower2.update(currentTime);

                buildings.forEach(b => b.update(currentTime)); 

                projectiles.forEach(p => p.update());

                monsters.forEach(m => m.update());

                // --- Kollisionshantering ---
                
                for (let i = projectiles.length - 1; i >= 0; i--) {
                    const p = projectiles[i];
                    let hit = false;

                    // Kontrollera om projektilens mål har dött.
                    if (p.target && p.target.hp <= 0) {
                        p.target = null;
                    }
                    
                    for (let j = monsters.length - 1; j >= 0; j--) {
                        const m = monsters[j];
                        
                        const dist = Math.hypot(p.x - m.x, p.y - m.y);
                        if (dist < p.radius + m.radius) {
                            m.takeDamage(p.damage);
                            hit = true;
                            
                            p.target = null; 

                            if (m.hp <= 0) {
                                monsters.splice(j, 1); 
                                monsterWaste++; 
                                updateUI();
                            }
                            break; 
                        }
                    }

                    const outsideBounds = p.x < -100 || p.x > canvas.width + 100 || p.y < -100 || p.y > canvas.height + 100;

                    if (hit || outsideBounds) {
                        projectiles.splice(i, 1);
                    }
                }

                // Kolla om monster nått basen
                for (let i = monsters.length - 1; i >= 0; i--) {
                    if (monsters[i].x - monsters[i].radius < tower.x + tower.width) {
                        monsters.splice(i, 1); 
                        baseHealth -= 10; 
                        console.log(`Basen tog skada! Hälsa: ${baseHealth}`);
                        if (baseHealth <= 0) {
                            console.log("GAME OVER");
                            gameState = 'GAME_OVER'; 
                            gameRunning = false; 
                        }
                    }
                }
                
                updateUI(); 

            } // Slut på if (gameRunning && gameState === 'PLAYING')

            // --- Ritningslogik (körs oavsett paus, men visas inte om GAME_OVER) ---
            
            if (tower) {
                // Rita tornen
                tower.draw();
                if (tower2) tower2.draw();
            }
            
            buildings.forEach(b => b.draw());

            projectiles.forEach(p => p.draw());

            monsters.forEach(m => m.draw());

            // Hantera paus/game over overlay
            if (gameState === 'PAUSED' || gameState === 'GAME_OVER') {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '50px sans-serif';
                ctx.textAlign = 'center';
                
                let overlayText = '';

                if (gameState === 'PAUSED') {
                    // Om Pausmeny är synlig, rita inte texten
                    if (pauseMenu.classList.contains('hidden')) { 
                        overlayText = 'PAUSAT (Tryck L)';
                        ctx.fillText(overlayText, canvas.width / 2, canvas.height / 2);
                    }
                } else if (gameState === 'GAME_OVER') {
                    overlayText = 'GAME OVER';
                    ctx.font = '70px sans-serif';
                    ctx.fillText(overlayText, canvas.width / 2, canvas.height / 2);
                    
                    // Om Game Over, visa pausmenyns knappar för omstart/återgång
                    pauseMenu.classList.remove('hidden');
                    document.getElementById('resumeButton').classList.add('hidden'); // Dölj "Återuppta"
                }
            } else {
                 document.getElementById('resumeButton').classList.add('hidden'); 
            }
            
            // Om vi är i placeringsläge, visa placeringsguide
            if (selectedBuildingType && gameState === 'PLAYING') {
                 ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                 ctx.font = '30px sans-serif';
                 ctx.textAlign = 'center';
                 ctx.fillText(`PLACERA ${selectedBuildingType}`, canvas.width / 2, 50);
                 
                 // Markör som rör sig med musen
                 const rect = canvas.getBoundingClientRect();
                 const mouseX = (window.mouseX - rect.left);
                 const mouseY = (window.mouseY - rect.top);
                 
                 // Building size för markör (använder större storlek för att vara generisk)
                 const markerSize = BUILDING_SIZE;
                 const isCollision = checkBuildingCollision(mouseX, mouseY);
                 const canPlace = mouseX >= BUILD_ZONE_LIMIT && !isCollision;
                 
                 ctx.strokeStyle = canPlace ? 'lime' : 'red';
                 ctx.lineWidth = 4;
                 
                 // Rektangulär markör för enkel placering
                 ctx.strokeRect(mouseX - markerSize/2, mouseY - markerSize/2, markerSize, markerSize);
                 
                 ctx.fillStyle = canPlace ? 'rgba(0, 255, 0, 0.1)' : 'rgba(255, 0, 0, 0.3)';
                 ctx.fillRect(mouseX - markerSize/2, mouseY - markerSize/2, markerSize, markerSize);
            }

            // Anropa nästa frame
            requestAnimationFrame(gameLoop);
        }

        // Uppdatera globala muspositioner för placeringsmarkören
        window.addEventListener('mousemove', (e) => {
            window.mouseX = e.clientX;
            window.mouseY = e.clientY;
        });

        // --- Starta spelet (Initialisering) ---
        // Sätt en initial tower instans 
        tower = new Tower(50, canvas.height / 2); 
        
        updateUI(); 
        requestAnimationFrame(gameLoop); 
    </script>
</body>
</html>
</div>

</body>
</html>
