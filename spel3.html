<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Basket Ball</title>

<style>
    body {
        margin: 0;
        background: black;
        overflow: hidden;
    }

    #game-container {
        width: 100vw;
        height: 100vh;
        background: black;
    }

    /* Flyttad till höger nedre hörn */
    .back {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.5);
        padding: 10px 16px;
        border-radius: 8px;
        color: white;
        text-decoration: none;
        border: 2px solid #666;
        z-index: 9999;
        font-size: 18px;
        cursor: pointer;
    }

    .back:hover {
        background: rgba(40,40,40,0.6);
    }
</style>
</head>
<body>

<!-- Stäng-knapp som stänger fliken -->
<button class="back" onclick="window.close()">✖ Stäng</button>

<div id="game-container">
    <!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Basketball Tournament - Uppgraderad med Paus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Press+Start+2P&display=swap');
        
        /* Globala stilar */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #0d111c; /* Mörkare bakgrund för kontrast */
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        #game-container {
            width: 95vw;
            max-width: 1400px;
            aspect-ratio: 16 / 9; /* Bättre för basketplan */
            min-height: 500px;
            background-color: #1f2937; /* Mörkblå/grå container */
            border: 10px solid #f97316; /* Orange ram */
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #game-canvas {
            background: linear-gradient(to bottom, #10b981 0%, #34d399 100%); /* Lätt grön/blå himmel */
            display: block;
            width: 100%;
            flex-grow: 1;
        }

        /* Stilar för alla Overlays */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
            text-align: center;
            padding: 20px;
        }
        
        .overlay h1 {
            font-family: 'Bungee Inline', cursive;
            font-size: clamp(3rem, 10vw, 5rem);
            color: #f59e0b; /* Gul orange */
            margin-bottom: 2rem;
            text-shadow: 6px 6px #dc2626, 8px 8px #000; /* Djupt röd/svart skugga */
        }
        
        .overlay h2 {
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(1rem, 4vw, 1.8rem);
            color: #94a3b8;
            margin-bottom: 1.5rem;
            line-height: 1.4;
        }

        .menu-button {
            background-color: #10b981; 
            color: white;
            font-family: 'Press Start 2P', cursive;
            padding: 1.2rem 2.5rem;
            margin: 0.7rem 0;
            border: 4px solid #047857; /* Tjockare kant */
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.15s ease-out, background-color 0.15s;
            box-shadow: 0 6px #059669;
            font-size: clamp(0.7rem, 2vw, 1.1rem);
            width: 90%;
            max-width: 400px;
        }

        .menu-button:hover {
            background-color: #059669;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px #057a55;
        }

        .menu-button:active {
            transform: translateY(3px);
            box-shadow: 0 3px #047857;
        }
        
        /* Casual / Svårighetsknappar */
        .difficulty-button {
            background-color: #6366f1;
            border-color: #4f46e5;
            box-shadow: 0 6px #4f46e5;
        }
        .difficulty-button:hover {
            background-color: #4f46e5;
            box-shadow: 0 8px #4338ca;
        }

        /* Back Button */
        .back-button {
            background-color: #94a3b8;
            border-color: #64748b;
            box-shadow: 0 6px #64748b;
        }
        .back-button:hover {
            background-color: #64748b;
            box-shadow: 0 8px #475569;
        }
        
        /* Pausknapp */
        .pause-button {
            background-color: #f59e0b;
            border-color: #d97706;
            box-shadow: 0 6px #d97706;
        }
        .pause-button:hover {
            background-color: #d97706;
            box-shadow: 0 8px #b45309;
        }


        /* Game UI */
        #game-ui {
            padding: 12px 20px;
            background-color: #0f172a; 
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.5rem, 2vw, 0.8rem);
            border-top: 5px solid #f97316;
            min-height: 50px;
        }
        
        #game-ui > span {
            padding: 5px 10px;
            border-radius: 6px;
        }
        
        #game-mode-info {
            background-color: #f59e0b;
            color: #0f172a;
        }
        
        #tournament-info {
            background-color: #3b82f6;
        }
        
        #score-player {
            color: #10b981;
        }
        
        #score-bot {
            color: #ef4444;
        }

        /* Meddelanderuta */
        #message-box {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            color: #1e293b;
            padding: 12px 24px;
            border-radius: 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.7);
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease;
            white-space: nowrap;
            animation: bounceIn 0.3s ease-out;
            border: 3px solid #f97316;
        }

        @keyframes bounceIn {
            0% { transform: translate(-50%, -10px) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, 0) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="game-canvas"></canvas>

    <div id="game-ui">
        <span id="game-mode-info">LÄGE: MENY</span>
        <span id="tournament-info" class="bg-gray-700">Runda 0/4</span>
        <span id="score-player">Spelare: 0</span>
        <span id="score-bot">Bot: 0</span>
    </div>
    
    <div id="message-box"></div>

    <!-- 1. Huvudmeny -->
    <div id="menu-overlay" class="overlay">
        <h1>Ultimate Basketball</h1>
        <h2 style="color: #f97316; margin-top: -1rem; margin-bottom: 2rem;">2D Arcade Hoops</h2>
        <button class="menu-button" onclick="showTournamentMode()">STARTA TURNERING (4 RUNDOR)</button>
        <button class="menu-button difficulty-button" onclick="showCasualMode()">VÄNSKAPSMATCH (VÄLJ NIVÅ)</button>
    </div>
    
    <!-- 2. Tournament Svårighetsval (Steg 2 i Turnering) -->
    <div id="tournament-difficulty-overlay" class="overlay" style="display:none;">
        <h2>Välkommen till Turneringen!</h2>
        <p style="color: #94a3b8; margin-bottom: 2rem; font-size: clamp(0.8rem, 2vw, 1.2rem);">
            Turneringen har 4 rundor. Svårighetsgraden ökar automatiskt i varje match.<br>
            Första motståndaren är *Snabbe Sven* på LÄTT nivå.
        </p>
        <button class="menu-button difficulty-button" onclick="startTournament()">STARTA TURNERING</button>
        <button class="menu-button back-button" onclick="showMainMenu()">TILLBAKA</button>
    </div>

    <!-- 3. Casual Mode Motståndarval -->
    <div id="casual-select-overlay" class="overlay" style="display:none;">
        <h2>Välj din motståndare</h2>
        <div id="opponent-buttons" style="display: flex; flex-direction: column; gap: 0.7rem; width: 90%; max-width: 400px;">
            <!-- Buttons populated by JS -->
        </div>
        <button class="menu-button back-button mt-4" onclick="showMainMenu()">TILLBAKA</button>
    </div>

    <!-- 4. Game Over / Runda Slut -->
    <div id="gameover-overlay" class="overlay" style="display:none;">
        <h1 id="gameover-title" style="font-size: clamp(2.5rem, 8vw, 4rem);">GRATTIS!</h1>
        <h2 id="gameover-message">Du vann turneringen!</h2>
        <button id="gameover-button" class="menu-button" onclick="showMainMenu()">SPELA IGEN</button>
    </div>
    
    <!-- 5. Pausmeny -->
    <div id="pause-overlay" class="overlay" style="display:none;">
        <h1>PAUS</h1>
        <h2 style="color: #f59e0b;">Spelet är pausat</h2>
        <p style="color: #94a3b8; margin-bottom: 2rem; font-size: clamp(0.8rem, 2vw, 1.2rem);">
            Tryck på L igen för att återuppta, eller välj nedan.
        </p>
        <button class="menu-button pause-button" onclick="unpauseGame()">FORTSÄTT SPEL</button>
        <button class="menu-button back-button" onclick="confirmReturnToMenu()">TILLBAKA TILL MENY</button>
    </div>
    
    <!-- 6. Bekräftelsemeny (för Return to Menu från Paus) -->
    <div id="confirm-overlay" class="overlay" style="display:none;">
        <h2>Är du säker?</h2>
        <p style="color: #94a3b8; margin-bottom: 2rem; font-size: clamp(0.8rem, 2vw, 1.2rem);">
            Du kommer att förlora dina framsteg i denna match/runda.
        </p>
        <button class="menu-button back-button" onclick="showMainMenu()">JA, ÅTERGÅ TILL MENY</button>
        <button class="menu-button pause-button" onclick="showPauseMenu()">NEJ, FORTSÄTT SPELA</button>
    </div>

</div>

<script>
    // --- KONSTANTER OCH SPELVARIABLER ---
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const gameContainer = document.getElementById('game-container');
    const menuOverlay = document.getElementById('menu-overlay');
    const tournamentDifficultyOverlay = document.getElementById('tournament-difficulty-overlay');
    const casualSelectOverlay = document.getElementById('casual-select-overlay');
    const gameoverOverlay = document.getElementById('gameover-overlay');
    const pauseOverlay = document.getElementById('pause-overlay'); // NYTT: Paus overlay
    const confirmOverlay = document.getElementById('confirm-overlay'); // NYTT: Bekräftelse overlay
    const gameoverTitleEl = document.getElementById('gameover-title');
    const gameoverMessageEl = document.getElementById('gameover-message');
    const gameoverButton = document.getElementById('gameover-button');
    const scorePlayerEl = document.getElementById('score-player');
    const scoreBotEl = document.getElementById('score-bot');
    const tournamentInfoEl = document.getElementById('tournament-info');
    const gameModeInfoEl = document.getElementById('game-mode-info');
    const opponentButtonsContainer = document.getElementById('opponent-buttons');
    const messageBox = document.getElementById('message-box');

    const MAX_SCORE = 5; 
    const STEAL_THRESHOLD_FRAMES = 90; 
    
    let gameLoopId = null; 
    let isGameRunning = false;
    let isGamePaused = false; // NYTT: Pausstatus
    let gameMode = 'MENU'; 
    let currentRound = 0;
    let totalRounds = 4;
    
    // Svårighetsinställningar (ändras per runda/match)
    let DIFFICULTY_MULTIPLIER = {
        level: 'easy', 
        speed: 1.0, 
        accuracy: 0.8, 
        reaction: 60, // Frames (lägre = snabbare)
        aggression: 0.5 // Chans att hoppa/interceptera
    };

    // Bot AI Inställningar baserat på svårighet
    const DIFFICULTY_SETTINGS = {
        easy: { level: 'easy', speed: 0.8, accuracy: 0.75, reaction: 90, aggression: 0.3 },
        normal: { level: 'normal', speed: 1.0, accuracy: 0.85, reaction: 60, aggression: 0.5 },
        hard: { level: 'hard', speed: 1.2, accuracy: 0.92, reaction: 40, aggression: 0.7 },
        impossible: { level: 'impossible', speed: 1.5, accuracy: 0.98, reaction: 30, aggression: 0.9 }
    };
    
    // Motståndardata (Estetik och Svårighetsnivå)
    const OPPONENT_DATA = [
        // Tournament Motståndare (Används i ordning)
        { id: 't1', name: "Snabbe Sven", level: 'easy', skinColor: '#fef3c7', shirtColor: '#10b981', hairColor: '#374151' },
        { id: 't2', name: "Norma Nisse", level: 'normal', skinColor: '#fcd34d', shirtColor: '#3b82f6', hairColor: '#0f172a' },
        { id: 't3', name: "Svåra Selma", level: 'hard', skinColor: '#a8713a', shirtColor: '#ef4444', hairColor: '#d946ef' },
        { id: 't4', name: "Den Oslagbara", level: 'impossible', skinColor: '#e0e0e0', shirtColor: '#a855f7', hairColor: '#ffffff' },
        
        // Casual Motståndare (Kan väljas fritt)
        { id: 'c1', name: "Lätta Lena", level: 'easy', skinColor: '#fef3c7', shirtColor: '#4c1d95', hairColor: '#e5e7eb' },
        { id: 'c2', name: "Mellanstora Max", level: 'normal', skinColor: '#fcd34d', shirtColor: '#d97706', hairColor: '#1f2937' },
        { id: 'c3', name: "Skjutande Stina", level: 'hard', skinColor: '#a8713a', shirtColor: '#065f46', hairColor: '#65a30d' },
        { id: 'c4', name: "Extreme Erik", level: 'impossible', skinColor: '#000000', shirtColor: '#000000', hairColor: '#ff0000' },
        { 
            id: 'c5', 
            name: "Jamaican Jamal", 
            level: 'impossible', 
            skinColor: '#43281C', 
            shirtColor: '#dc2626', 
            hairColor: '#0f172a', 
            isPlayerSpeed: true 
        }
    ];

    // Spelets konstanter
    const GRAVITY = 0.5;
    const COURT_HEIGHT_FACTOR = 0.85; 
    const SHOOT_PEAK_HEIGHT_FACTOR = 0.3; 
    const MIN_PEAK_HEIGHT = 100; 
    const BOT_SHOOT_DISTANCE = 300; 
    const COLLISION_DISTANCE_SQ = (30 * 1.5) ** 2; 
    
    // Spelar- och Bot-objekt (Gubbar)
    const player = {
        x: 100, y: 0, width: 30, height: 70, 
        dx: 0, dy: 0, speed: 6, jumpPower: 12, isJumping: false,
        hasBall: false, score: 0, name: "Spelare",
        facing: 1, 
        frame: 0, frameTimer: 0, stealTimer: 0,
        skinColor: '#fef3c7', shirtColor: '#f59e0b', hairColor: '#374151',
        isPlayerSpeed: false 
    };

    const bot = {
        x: 1100, y: 0, width: 30, height: 70, 
        dx: 0, dy: 0, speed: 4, jumpPower: 12, isJumping: false,
        hasBall: false, score: 0, name: "Bot",
        facing: -1, 
        frame: 0, frameTimer: 0, stealTimer: 0,
        skinColor: '#a8713a', shirtColor: '#ef4444', hairColor: '#0f172a',
        isPlayerSpeed: false 
    };

    // Basketboll-objekt
    const ball = {
        x: 600, y: 0, radius: 10, color: '#f97316', // Orange boll
        dx: 0, dy: 0,
        isMoving: false,
        owner: null 
    };

    // Basketkorgar
    const hoops = {
        player: { x: 50, y: 0, height: 200, color: '#0f172a', targetX: 60, targetY: 250 }, 
        bot: { x: 1150, y: 0, height: 200, color: '#0f172a', targetX: 1140, targetY: 250 } 
    };

    // Kontrollstatus
    const keys = { 'a': false, 'd': false, 'w': false, 'f': false };

    // --- INITIALISERING OCH RITFUNKTIONER ---

    function resizeCanvas() {
        const uiHeight = document.getElementById('game-ui')?.offsetHeight || 50; 
        const newWidth = gameContainer.clientWidth;
        const newHeight = gameContainer.clientHeight - uiHeight;

        canvas.width = newWidth;
        canvas.height = newHeight;
        
        player.groundY = canvas.height * COURT_HEIGHT_FACTOR;
        bot.groundY = canvas.height * COURT_HEIGHT_FACTOR;
        ball.groundY = player.groundY;

        hoops.player.y = player.groundY;
        hoops.bot.y = bot.groundY;
        hoops.bot.x = canvas.width - 50;
        hoops.bot.targetX = canvas.width - 60;
        
        if (isGameRunning || gameMode !== 'MENU') {
            resetPlayersAndBall(ball.owner || player, true); 
        }
    }

    // Funktioner för drawPlayer, updateAnimation, drawBall, drawHoop, drawCourt är oförändrade

    function drawPlayer(p) {
        const facingDirection = p.facing; 
        const bodyWidth = 22;
        const limbWidth = 6;
        const bodyX = p.x - bodyWidth / 2;
        const legY = p.y + p.height; 
        
        // Gånganimation
        let legOffset1 = 0; 
        let legOffset2 = 0; 
        const walkAmplitude = 4; 
        
        if (p.dx !== 0 && !p.isJumping) {
            const frameIndex = p.frame; 
            if (frameIndex === 1) { 
                legOffset1 = -walkAmplitude;
                legOffset2 = walkAmplitude;
            } else { 
                legOffset1 = walkAmplitude; 
                legOffset2 = -walkAmplitude; 
            }
        }
        
        // HUVUD OCH HÅR
        const headHeight = 15;
        const headWidth = p.width / 2;
        const headX = p.x - headWidth / 2; 
        const headY = p.y - headHeight;
        
        ctx.fillStyle = p.skinColor; 
        ctx.fillRect(headX, headY, headWidth, headHeight);

        ctx.fillStyle = p.hairColor; 
        const hairHeight = 5;
        ctx.fillRect(headX, headY - hairHeight, headWidth, hairHeight);

        // KROPP (Tröja)
        ctx.fillStyle = p.shirtColor;
        ctx.fillRect(bodyX, p.y, bodyWidth, p.height / 2);
        
        // Byxor/Shorts (Använd en neutral mörk färg)
        ctx.fillStyle = '#1f2937'; 
        ctx.fillRect(bodyX, p.y + p.height / 2, bodyWidth, p.height / 2);

        // BEN 
        ctx.fillStyle = p.skinColor;
        const legLength = p.height / 3;
        
        // Ben 1 (Vänster ben från betraktaren)
        ctx.fillRect(p.x - bodyWidth / 2 + 2, legY - legLength + legOffset1, limbWidth, legLength);
        // Ben 2 (Höger ben från betraktaren)
        ctx.fillRect(p.x + bodyWidth / 2 - limbWidth - 2, legY - legLength + legOffset2, limbWidth, legLength);
        
        // ARM (enkel block)
        ctx.fillStyle = p.skinColor;
        const armY = p.y + p.height / 4;
        const armLength = p.height / 4;
        
        // Arm 1 (Mot boll/framåt)
        const armX1 = p.x + (facingDirection * bodyWidth / 2);
        ctx.fillRect(armX1 - limbWidth / 2, armY, limbWidth, armLength);


        // BOLL
        if (p.hasBall) {
            ctx.fillStyle = ball.color;
            ctx.beginPath();
            // Placera bollen nära handen/armbågen framför
            const ballX = p.x + (facingDirection * (p.width / 2));
            const ballY = armY + armLength;
            ctx.arc(ballX, ballY, ball.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Stöldindikator (Visuell feedback för stöld)
            if (p.stealTimer > 0 && p.stealTimer < STEAL_THRESHOLD_FRAMES) {
                 const percentage = p.stealTimer / STEAL_THRESHOLD_FRAMES;
                 ctx.fillStyle = `rgba(255, 0, 0, ${percentage * 0.5})`;
                 ctx.beginPath();
                 ctx.arc(p.x, p.y + p.height / 2, p.width, 0, Math.PI * 2);
                 ctx.fill();
            }
        }
    }
    
    function updateAnimation(p) {
        if (p.dx !== 0 && !p.isJumping) {
            p.frameTimer++;
            if (p.frameTimer > 8) { 
                p.frame = 1 - p.frame; 
                p.frameTimer = 0;
            }
        } else {
            p.frame = 0; 
            p.frameTimer = 0;
        }
    }

    function drawBall() {
        ctx.fillStyle = ball.color;
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
        ctx.fill();

        // Basketboll linjer
        ctx.strokeStyle = '#0f172a';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(ball.x - ball.radius, ball.y);
        ctx.lineTo(ball.x + ball.radius, ball.y);
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius / 2, 0, Math.PI * 2);
        ctx.stroke();
    }

    function drawHoop(hoop) {
        const poleWidth = 10;
        const rimLength = 50;
        const rimThickness = 5;
        const backboardHeight = 50;
        const backboardWidth = 5;

        // Rita stolpen (Svart)
        ctx.fillStyle = hoop.color;
        ctx.fillRect(hoop.x - poleWidth / 2, hoop.y - hoop.height, poleWidth, hoop.height);
        
        // Rita bakplattan (Backboard - Vit med röd kant)
        const backboardX = hoop.x + (hoop === hoops.player ? 0 : -backboardWidth);
        ctx.fillStyle = '#fefefe';
        ctx.fillRect(backboardX, hoop.y - hoop.height - backboardHeight, backboardWidth, backboardHeight);
        ctx.strokeStyle = '#dc2626';
        ctx.lineWidth = 2;
        ctx.strokeRect(backboardX, hoop.y - hoop.height - backboardHeight, backboardWidth, backboardHeight);


        // Rita korgring (Rim - Röd)
        ctx.fillStyle = '#dc2626';
        const rimX = hoop.x + (hoop === hoops.player ? backboardWidth : -rimLength);
        ctx.fillRect(rimX, hoop.y - hoop.height, rimLength, rimThickness);

        // Rita nätet (Net - Linjer)
        ctx.strokeStyle = '#fefefe';
        ctx.lineWidth = 1;
        const netY = hoop.y - hoop.height + rimThickness;
        const netDepth = 25;
        const numLines = 5;

        for (let i = 0; i <= numLines; i++) {
            const ratio = i / numLines;
            ctx.beginPath();
            // Rita vertikala/diagonal linjer
            ctx.moveTo(rimX + (rimLength * ratio), netY);
            ctx.lineTo(rimX + (rimLength / 2) + ((rimLength / 2 - rimLength * ratio) * 0.5), netY + netDepth);
            ctx.stroke();
        }
        
        // Uppdatera skjutmål (target) för träffkoll
        hoop.targetX = rimX + rimLength / 2;
        hoop.targetY = netY; // Målet är nätets topp
    }

    function drawCourt() {
        // Mark (Basketparkett)
        const woodLight = '#a0522d'; // Ljusbrun
        const woodDark = '#8b4513'; // Mörkbrun
        const groundY = player.groundY;
        
        // Bakgrundsfärg (en av träfärgerna)
        ctx.fillStyle = woodDark;
        ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);

        // Rita träribbor (enkel linjetextur)
        ctx.strokeStyle = woodLight;
        ctx.lineWidth = 1;
        const numPlanks = 40;
        for (let i = 0; i < numPlanks; i++) {
            ctx.beginPath();
            const y = groundY + (i / numPlanks) * (canvas.height - groundY);
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }
        
        // Marklinjer (Vit)
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 4;
        
        // Mittlinje
        ctx.beginPath();
        ctx.moveTo(canvas.width/2, groundY);
        ctx.lineTo(canvas.width/2, groundY - 150);
        ctx.stroke();
        
        // Fri-kast linje (Simulerad: 200px från korg)
        const ftLength = 100;
        const ftY = groundY - 150;
        
        // Fri-kast linje Spelare
        ctx.beginPath();
        ctx.moveTo(hoops.player.x + 200, ftY);
        ctx.lineTo(hoops.player.x + 200, groundY);
        ctx.stroke();
        
        // Fri-kast linje Bot
        ctx.beginPath();
        ctx.moveTo(hoops.bot.x - 200, ftY);
        ctx.lineTo(hoops.bot.x - 200, groundY);
        ctx.stroke();
    }


    function showMessage(text) {
        messageBox.textContent = text;
        messageBox.style.opacity = '1';
        messageBox.style.transform = 'translateX(-50%) scale(1)';
        
        clearTimeout(messageBox.timer);
        messageBox.timer = setTimeout(() => {
            messageBox.style.opacity = '0';
        }, 2000);
    }
    
    // --- SPEL LOGIK ---

    function updatePlayer(p) {
        // Rörelse och Ansiktsriktning (Endast för Spelaren)
        if (p === player) {
            p.dx = 0;
            if (keys['a']) {
                p.dx = -p.speed;
                p.facing = -1; 
            } else if (keys['d']) {
                p.dx = p.speed;
                p.facing = 1; 
            }
        }
        
        // Botens facing
        if (p === bot) {
            const targetX = bot.hasBall ? hoops.player.targetX : ball.x;
            p.facing = targetX > p.x ? 1 : -1;
            
            const baseSpeed = bot.isPlayerSpeed ? player.speed : 4; 
            p.speed = baseSpeed * DIFFICULTY_MULTIPLIER.speed; 
        }

        // Applicera rörelse
        p.x += p.dx;

        // Studsa mot väggar
        const halfWidth = p.width / 2;
        if (p.x < halfWidth) {
            p.x = halfWidth;
            p.dx = 0;
        } else if (p.x > canvas.width - halfWidth) {
            p.x = canvas.width - halfWidth;
            p.dx = 0;
        }

        // Hopp och gravitation
        if (p.isJumping) {
            p.dy += GRAVITY;
            p.y += p.dy;
        }

        // Kollision med marken
        if (p.y + p.height >= p.groundY) { 
            p.y = p.groundY - p.height;
            p.dy = 0;
            p.isJumping = false;
        }

        // Bollen följer spelaren
        if (p.hasBall) {
            const ballXOffset = p.width / 2 * p.facing + (ball.radius * p.facing);
            
            // Dribbling animation
            const dribbleHeight = p.isJumping ? 0 : 5;
            ball.y = p.y + p.height / 2 + Math.sin(p.frameTimer * 0.5) * dribbleHeight;

            ball.x = p.x + ballXOffset;
            ball.dx = 0; 
            ball.dy = 0; 
            ball.isMoving = false;
            ball.owner = p;
        }
        
        updateAnimation(p);
    }
    
    function botLogic() {
        if (!isGameRunning || isGamePaused) return; // FIX: Stoppa boten om pausad

        const targetHoop = hoops.player;
        const shootRange = BOT_SHOOT_DISTANCE; 
        const shootX = targetHoop.targetX + (shootRange + (1 - DIFFICULTY_MULTIPLIER.accuracy) * 100); 
        
        const reactionDelay = DIFFICULTY_MULTIPLIER.reaction;
        if (Math.random() * 60 < reactionDelay / 3) return; 
        
        if (bot.hasBall) {
            const dxToShootPosition = shootX - bot.x;
            
            if (Math.abs(dxToShootPosition) > 10) {
                 bot.dx = Math.sign(dxToShootPosition) * bot.speed;
            } else {
                bot.dx = 0;
                
                if (!bot.isJumping) {
                    shootBall(bot, targetHoop);
                }
            }
        } else {
            const dx = ball.x - bot.x;
            const distance = Math.abs(dx); 
            const ballIsFree = !ball.owner;

            if (player.hasBall) {
                 const targetBlockX = player.x + (player.facing === 1 ? player.width : -player.width);
                 const blockDx = targetBlockX - bot.x;
                 
                 if (Math.abs(blockDx) > 5) {
                    bot.dx = Math.sign(blockDx) * (bot.speed * 1.2); 
                 } else {
                    bot.dx = 0;
                 }
                 
                 if (player.isJumping && Math.random() < DIFFICULTY_MULTIPLIER.aggression * 0.5 && distance < 150) {
                    botJump();
                 }

            } else if (ballIsFree && distance < canvas.width / 2) {
                if (Math.abs(dx) > 5) {
                    bot.dx = Math.sign(dx) * bot.speed;
                } else {
                    bot.dx = 0;
                }
                
                if (ball.isMoving && ball.y < bot.y && Math.random() < DIFFICULTY_MULTIPLIER.aggression) {
                    botJump();
                }

            } else {
                 bot.dx = 0;
            }
        }
    }

    function updateBall() {
        if (ball.owner) return; 

        if (ball.isMoving) {
            ball.dy += GRAVITY;
            ball.dx *= 0.995; 

            ball.x += ball.dx;
            ball.y += ball.dy;
            
            if (ball.y + ball.radius >= ball.groundY) {
                ball.y = ball.groundY - ball.radius;
                ball.dy *= -0.7; 
                ball.dx *= 0.95; 
                
                if (Math.abs(ball.dy) < 1 && Math.abs(ball.dx) < 1) { 
                    ball.dy = 0;
                    ball.dx = 0;
                    ball.isMoving = false;
                }
            }
            
            if (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width) {
                ball.dx *= -0.9;
                ball.x = Math.max(ball.radius, Math.min(canvas.width - ball.radius, ball.x));
            }

            const targetHoop = ball.x < canvas.width / 2 ? hoops.player : hoops.bot;
            const backboardX = targetHoop === hoops.player ? targetHoop.x + 0 : targetHoop.x - 5;
            const backboardWidth = 5;
            const backboardTop = targetHoop.y - targetHoop.height - 50;
            const backboardBottom = targetHoop.y - targetHoop.height;

            if (ball.y > backboardTop && ball.y < backboardBottom) {
                if (targetHoop === hoops.bot && ball.x + ball.radius > backboardX && ball.x + ball.radius < backboardX + backboardWidth && ball.dx > 0) {
                    ball.dx *= -0.7;
                    ball.x = backboardX - ball.radius;
                }
                else if (targetHoop === hoops.player && ball.x - ball.radius < backboardX + backboardWidth && ball.x - ball.radius > backboardX && ball.dx < 0) {
                    ball.dx *= -0.7;
                    ball.x = backboardX + backboardWidth + ball.radius;
                }
            }
        }
    }

    function checkCollision(p, b) {
        const closestX = Math.max(p.x - p.width / 2, Math.min(b.x, p.x + p.width / 2));
        const closestY = Math.max(p.y, Math.min(b.y, p.y + p.height));
        
        const dx = b.x - closestX;
        const dy = b.y - closestY;
        
        return (dx * dx + dy * dy) < (b.radius * b.radius);
    }

    function handleBallControl() {
        if (ball.owner) return; 

        const players = [player, bot];

        for (const p of players) {
            if (checkCollision(p, ball) && !p.hasBall && !ball.owner) {
                p.hasBall = true;
                ball.owner = p;
                ball.isMoving = false;
                showMessage(`${p.name} tog bollen!`);

                player.stealTimer = 0;
                bot.stealTimer = 0;
                return;
            }
        }
    }
    
    function checkSteal() {
        const dx = player.x - bot.x;
        const dy = player.y - bot.y;
        const distanceSq = dx * dx + dy * dy;

        if (distanceSq < COLLISION_DISTANCE_SQ) {
            
            let stealer = null;
            let ballCarrier = null;

            if (bot.hasBall) {
                stealer = player;
                ballCarrier = bot;
            } else if (player.hasBall) {
                stealer = bot;
                ballCarrier = player;
            } else {
                 player.stealTimer = 0;
                 bot.stealTimer = 0;
                 return;
            }
            
            stealer.stealTimer++;
            ballCarrier.stealTimer = 0; 

            const threshold = stealer === bot 
                ? STEAL_THRESHOLD_FRAMES * (1 / DIFFICULTY_MULTIPLIER.accuracy) * 0.75 
                : STEAL_THRESHOLD_FRAMES;
            
            if (stealer.stealTimer > threshold) {
                ballCarrier.hasBall = false;
                ball.owner = stealer;
                stealer.hasBall = true;
                stealer.stealTimer = 0;
                showMessage(`${stealer.name} stjäl bollen!`);
            }
        } else {
            player.stealTimer = 0;
            bot.stealTimer = 0;
        }
    }


    function shootBall(shooter, targetHoop) {
        if (!shooter.hasBall) return;
        
        shooter.hasBall = false;
        ball.owner = null;
        ball.isMoving = true;

        const ballStartY = shooter.y + shooter.height / 2;
        const targetY = targetHoop.targetY; 
        
        const dx = targetHoop.targetX - shooter.x;
        
        const t_min_base = 15; 
        const t_max = 50; 
        const t_raw = Math.abs(dx) / 15; 
        const t = Math.min(t_max, Math.max(t_min_base, t_raw)); 

        let Vx = dx / t;

        const initialPeakY = ballStartY - MIN_PEAK_HEIGHT; 
        const absolutePeakY = canvas.height * SHOOT_PEAK_HEIGHT_FACTOR; 
        
        const desiredPeakY = Math.min(initialPeakY, absolutePeakY);

        const dyToPeak = ballStartY - desiredPeakY;
        const Vy_up = -Math.sqrt(2 * GRAVITY * dyToPeak); 

        const t_peak = -Vy_up / GRAVITY;
        
        const dy_fall = targetY - desiredPeakY;
        let t_fall = Math.sqrt(2 * dy_fall / GRAVITY);
        
        const T = t_peak + t_fall; 

        let newVx = dx / T;
        let newVy = Vy_up; 

        const accuracyFactor = shooter === bot ? DIFFICULTY_MULTIPLIER.accuracy : 1.0;
        const noiseRange = (1.0 - accuracyFactor) * 0.4; 
        const noiseX = (Math.random() - 0.5) * noiseRange * 1.5; 
        const noiseY = (Math.random() - 0.5) * noiseRange * 0.8; 
        
        newVx *= (1 + noiseX);
        newVy *= (1 + noiseY);
        
        ball.dx = newVx;
        ball.dy = newVy;
        
        showMessage(shooter === player ? "SKJUT! Lycka till." : `${shooter.name} skjuter...`);
    }

    function checkScore() {
        if (gameLoopId && gameLoopId % 5 !== 0) return;

        if (!ball.isMoving || ball.owner || ball.y + ball.radius >= ball.groundY) return; 

        const targetHoop = ball.x < canvas.width / 2 ? hoops.player : hoops.bot;
        
        const rimXStart = targetHoop === hoops.player ? targetHoop.x + 5 : targetHoop.x - 50; 
        const rimWidth = 50;
        
        if (ball.dy > 0 && 
            ball.x + ball.radius > rimXStart && 
            ball.x - ball.radius < rimXStart + rimWidth) {
            
            if (ball.y <= targetHoop.targetY && ball.y + ball.radius + ball.dy >= targetHoop.targetY) {
                
                let scorer = null;
                let hoopOwner = null;
                
                if (targetHoop === hoops.bot) {
                    scorer = player;
                    hoopOwner = bot; 
                } 
                else if (targetHoop === hoops.player) {
                    scorer = bot;
                    hoopOwner = player; 
                }

                if (scorer) {
                    scorer.score++;
                    updateScoreDisplay();
                    showMessage(`${scorer.name} GÖR MÅL! POÄNG!`);
                    
                    ball.isMoving = false;
                    ball.dx = 0;
                    ball.dy = 0;
                    ball.y = targetHoop.targetY + targetHoop.height + ball.radius; 

                    
                    if (scorer.score >= MAX_SCORE) {
                        endRound(scorer);
                        return;
                    }
                    
                    setTimeout(() => resetPlayersAndBall(hoopOwner), 500); 
                }
            }
        }
    }
    
    // --- MENY OCH LÄGES HANTERING ---

    function setupBot(opponentData) {
        const settings = DIFFICULTY_SETTINGS[opponentData.level];

        bot.name = opponentData.name;
        bot.shirtColor = opponentData.shirtColor;
        bot.skinColor = opponentData.skinColor;
        bot.hairColor = opponentData.hairColor;
        bot.isPlayerSpeed = opponentData.isPlayerSpeed || false;
        
        DIFFICULTY_MULTIPLIER = settings;
    }
    
    function startCasual(opponentId) {
        if (gameLoopId) {
             cancelAnimationFrame(gameLoopId);
             gameLoopId = null;
        }

        gameMode = 'CASUAL';
        isGamePaused = false; // Säkerställ att spelet inte är pausat
        const opponent = OPPONENT_DATA.find(o => o.id === opponentId);
        setupBot(opponent);
        
        player.score = 0;
        bot.score = 0;
        
        resetPlayersAndBall(player);

        isGameRunning = true;
        casualSelectOverlay.style.display = 'none';
        
        updateScoreDisplay();
        showMessage(`Vänskapsmatch mot ${bot.name} (${DIFFICULTY_MULTIPLIER.level.toUpperCase()})`);
        
        gameLoop();
    }

    function startTournament() {
        if (gameLoopId) {
             cancelAnimationFrame(gameLoopId);
             gameLoopId = null;
        }

        gameMode = 'TOURNAMENT';
        isGamePaused = false; // Säkerställ att spelet inte är pausat
        currentRound = 1;
        player.totalWins = 0;
        
        tournamentDifficultyOverlay.style.display = 'none';
        gameoverOverlay.style.display = 'none';

        startRound();
    }
    
    function startRound() {
        gameoverOverlay.style.display = 'none';
        
        if (gameLoopId) {
             cancelAnimationFrame(gameLoopId);
             gameLoopId = null;
        }

        if (currentRound > totalRounds) {
            endTournament(true); 
            return;
        }
        
        const opponent = OPPONENT_DATA.find(o => o.id === `t${currentRound}`);
        if (!opponent) {
             console.error(`Kunde inte hitta motståndare för runda ${currentRound}`);
             endTournament(false); 
             return;
        }

        setupBot(opponent);
        
        player.score = 0;
        bot.score = 0;
        
        resetPlayersAndBall(player); 

        isGameRunning = true;
        isGamePaused = false;
        updateScoreDisplay();
        showMessage(`RUNDA ${currentRound}: Mot ${bot.name} (${DIFFICULTY_MULTIPLIER.level.toUpperCase()})`);
        
        gameLoop();
    }
    
    function endRound(winner) {
        isGameRunning = false;
        isGamePaused = false; // Säkerställ att paus är borta
        
        if (gameLoopId) {
            cancelAnimationFrame(gameLoopId);
            gameLoopId = null;
        }
        
        if (gameMode === 'CASUAL') {
            gameoverTitleEl.textContent = winner === player ? "MATCH VINST!" : "MATCH FÖRLUST!";
            gameoverMessageEl.textContent = winner === player 
                ? `Du vann mot ${bot.name} med ${player.score}-${bot.score}!` 
                : `${bot.name} vann matchen med ${bot.score}-${player.score}.`;
                
            gameoverButton.textContent = "NY VÄNSKAPSMATCH";
            gameoverButton.onclick = showCasualMode; 
            
        } else if (gameMode === 'TOURNAMENT') {
            if (winner === player) {
                player.totalWins++;
                currentRound++;
                
                if (currentRound > totalRounds) {
                    endTournament(true);
                } else {
                    gameoverTitleEl.textContent = "RUNDA VINST!";
                    gameoverMessageEl.textContent = `Du besegrade ${bot.name}. Fortsätt till Runda ${currentRound}/${totalRounds}.`;
                    
                    gameoverButton.textContent = "FORTSÄTT TILL NÄSTA RUNDA";
                    gameoverButton.onclick = startRound; 
                }
            } else {
                endTournament(false); 
            }
        }

        gameoverOverlay.style.display = 'flex';
    }

    function endTournament(isWinner) {
        isGameRunning = false;
        isGamePaused = false; // Säkerställ att paus är borta

        if (gameLoopId) {
            cancelAnimationFrame(gameLoopId);
            gameLoopId = null;
        }
        
        if (isWinner) {
            gameoverTitleEl.textContent = "TURNERINGSMÄSTARE!";
            gameoverMessageEl.textContent = "Du har besegrat alla motståndare och vinner titeln!";
        } else {
            gameoverTitleEl.textContent = "TURNERINGEN SLUT!";
            gameoverMessageEl.textContent = `${bot.name} var för svår. Försök igen från början.`;
        }
        
        gameoverButton.textContent = "TILLBAKA TILL MENY";
        gameoverButton.onclick = showMainMenu;
        
        gameoverOverlay.style.display = 'flex';
    }

    function hideAllOverlays() {
        menuOverlay.style.display = 'none';
        tournamentDifficultyOverlay.style.display = 'none';
        casualSelectOverlay.style.display = 'none';
        gameoverOverlay.style.display = 'none';
        pauseOverlay.style.display = 'none'; // NYTT
        confirmOverlay.style.display = 'none'; // NYTT
    }

    function showMainMenu() {
        hideAllOverlays();
        
        if (gameLoopId) {
             cancelAnimationFrame(gameLoopId);
             gameLoopId = null;
        }
        
        menuOverlay.style.display = 'flex';
        isGameRunning = false;
        isGamePaused = false;
        
        updateScoreDisplay(); 
        gameModeInfoEl.textContent = "LÄGE: MENY";
        tournamentInfoEl.textContent = "Runda 0/4";
    }

    function showTournamentMode() {
        hideAllOverlays();
        tournamentDifficultyOverlay.style.display = 'flex';
    }

    function showCasualMode() {
        hideAllOverlays();
        casualSelectOverlay.style.display = 'flex';
        
        opponentButtonsContainer.innerHTML = '';
        
        const casualOpponents = OPPONENT_DATA.filter(o => o.id.startsWith('c'));
        
        casualOpponents.forEach(opponent => {
            const button = document.createElement('button');
            button.className = 'menu-button difficulty-button';
            button.textContent = `${opponent.name} (${opponent.level.toUpperCase()})`;
            button.onclick = () => startCasual(opponent.id);
            opponentButtonsContainer.appendChild(button);
        });
    }
    
    // NYTT: Paus-hantering
    function showPauseMenu() {
        if (!isGameRunning) return;
        
        isGamePaused = true;
        pauseOverlay.style.display = 'flex';
        confirmOverlay.style.display = 'none';
    }

    function unpauseGame() {
        isGamePaused = false;
        pauseOverlay.style.display = 'none';
        confirmOverlay.style.display = 'none';
        
        // Återuppta spel loopen
        if (gameLoopId === null) {
            gameLoop();
        }
    }
    
    function confirmReturnToMenu() {
        pauseOverlay.style.display = 'none';
        confirmOverlay.style.display = 'flex';
    }


    function resetPlayersAndBall(starter, keepPosition = false) {
        if (!player.groundY) resizeCanvas();

        if (!keepPosition) {
            player.x = 100; player.dx = 0; player.dy = 0; player.isJumping = false;
            bot.x = canvas.width - 100; bot.dx = 0; bot.dy = 0; bot.isJumping = false;
        } else {
            player.dx = 0; player.dy = 0; player.isJumping = false;
            bot.dx = 0; bot.dy = 0; bot.isJumping = false;
        }

        player.y = player.groundY - player.height;
        player.facing = 1; 
        
        bot.y = bot.groundY - bot.height;
        bot.facing = -1; 
        
        ball.x = canvas.width / 2;
        ball.y = ball.groundY - ball.radius;
        ball.dx = 0;
        ball.dy = 0;
        ball.isMoving = false;
        ball.owner = null;
        player.hasBall = false;
        bot.hasBall = false;
        
        player.stealTimer = 0;
        bot.stealTimer = 0;

        if (starter) {
            starter.hasBall = true;
            ball.owner = starter;
            updatePlayer(starter);
        } else {
             ball.y = ball.groundY - ball.radius;
        }
    }

    function updateScoreDisplay() {
        scorePlayerEl.textContent = `SPELARE: ${player.score}`;
        scoreBotEl.textContent = `${bot.name.toUpperCase()}: ${bot.score}`;
        
        gameModeInfoEl.textContent = `LÄGE: ${gameMode}`;
        
        const currentLevel = DIFFICULTY_MULTIPLIER.level.toUpperCase();

        if (gameMode === 'TOURNAMENT') {
             tournamentInfoEl.textContent = `RUNDA ${currentRound}/${totalRounds} (${currentLevel})`;
        } else if (gameMode === 'CASUAL') {
             tournamentInfoEl.textContent = `VÄNSKAP (${currentLevel})`;
        } else {
             tournamentInfoEl.textContent = ` `;
        }
    }

    // --- KONTROLLER ---

    function playerJump() {
        if (!player.isJumping) {
            player.isJumping = true;
            player.dy = -player.jumpPower;
        }
    }
    
    function botJump() {
        if (!bot.isJumping) {
            bot.isJumping = true;
            bot.dy = -bot.jumpPower;
        }
    }

    window.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        
        // Pausknapp fungerar alltid när spelet körs
        if (key === 'l' && isGameRunning) {
            if (isGamePaused) {
                unpauseGame();
            } else {
                showPauseMenu();
            }
            return;
        }
        
        if (!isGameRunning || isGamePaused) return;

        if (key in keys) {
            keys[key] = true;
        }
        
        if (key === 'w' || key === ' ') {
            e.preventDefault();
            playerJump();
        }
        
        if (key === 'f' && player.hasBall) {
            e.preventDefault(); 
            shootBall(player, hoops.bot);
        }
    });

    window.addEventListener('keyup', (e) => {
        const key = e.key.toLowerCase();
        if (key in keys) {
            keys[key] = false;
        }
    });

    window.addEventListener('resize', resizeCanvas);

    // --- SPELENS HUVUDLÖP ---

    function gameLoop(timestamp) {
        if (!isGameRunning) {
            if (gameLoopId !== null) {
                cancelAnimationFrame(gameLoopId);
                gameLoopId = null;
            }
            return;
        }
        
        // Stoppa loopen om spelet är pausat
        if (isGamePaused) {
             gameLoopId = requestAnimationFrame(gameLoop); // Håll requestAnimationFrame igång för att kolla pausstatus
             return;
        }
        
        // Rensa canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Rita scenen
        drawCourt();
        drawHoop(hoops.player);
        drawHoop(hoops.bot);
        
        // Botens AI
        botLogic();

        // Uppdatera spelare
        updatePlayer(player);
        updatePlayer(bot);
        
        // Kontrollera stöld
        checkSteal();
        
        // Uppdatera bollen
        updateBall();
        
        // Hantera bollkontroll (plocka upp lös boll)
        handleBallControl();

        // Kontrollera poäng
        checkScore();

        // Rita element
        drawBall();
        drawPlayer(player);
        drawPlayer(bot);


        // Nästa frame
        gameLoopId = requestAnimationFrame(gameLoop);
    }
    
    // --- START ---
    
    window.onload = function () {
        resizeCanvas(); 
        showMainMenu();
    };
    
</script>
</body>
</html>
</div>

</body>
</html>
